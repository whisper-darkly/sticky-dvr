# sticky-proxy NGINX config
# Handles: TLS termination, JWT validation, path routing

js_path     "/etc/nginx/njs/";
js_import   jwt from jwt-validate.js;

# Upstream backends (resolved via Docker DNS inside compose network)
upstream backend {
    server backend:8080;
    keepalive 32;
}

upstream frontend {
    server frontend:80;
    keepalive 16;
}

upstream fileserver {
    server fileserver:80;
    keepalive 8;
}

# thumbnailer is a WebSocket worker process, not an HTTP file server.
# Thumbnails are written to the recordings directory by the thumbnailer worker
# and served by the fileserver. The /thumbnails/ location below handles this.

# ---- HTTP → HTTPS redirect ----
server {
    listen 80;
    server_name _;
    return 301 https://$host$request_uri;
}

# ---- HTTPS main server ----
server {
    listen 443 ssl;
    server_name _;

    # NJS variables set by jwt-validate.js; forwarded to backend as request headers.
    js_var $jwt_user_id;
    js_var $jwt_user_role;

    ssl_certificate     /etc/nginx/certs/tls.crt;
    ssl_certificate_key /etc/nginx/certs/tls.key;
    ssl_protocols       TLSv1.2 TLSv1.3;
    ssl_ciphers         HIGH:!aNULL:!MD5;
    ssl_session_cache   shared:SSL:10m;
    ssl_session_timeout 10m;

    # Security headers
    add_header X-Content-Type-Options nosniff;
    add_header X-Frame-Options SAMEORIGIN;
    add_header Referrer-Policy strict-origin-when-cross-origin;

    # ---- JWT validation for /api/* (except public paths) ----
    location /api/ {
        js_content jwt.validateJwt;
    }

    # ---- Media files — JWT-protected (cookie), routed to fileserver ----
    location /media/subscriptions/ {
        js_content jwt.validateJwt;
    }

    # Internal fileserver proxy for media (strip /media/subscriptions prefix in NJS)
    location /fileserver-internal/ {
        internal;
        proxy_pass         http://fileserver/;
        proxy_set_header   Host $host;
        proxy_http_version 1.1;
        proxy_set_header   Connection "";
        # Rewrite any fileserver redirects back to the public /media/subscriptions/ path
        proxy_redirect     ~*^https?://[^/]+/(.*)$ /media/subscriptions/$1;
    }

    # Named backend proxy target (used by NJS internalRedirect)
    location @backend {
        proxy_pass         http://backend;
        proxy_http_version 1.1;
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
        proxy_set_header   Connection        "";

        # Pass NJS-injected user headers to backend (sourced from js_var declarations above)
        proxy_set_header   X-User-Id         $jwt_user_id;
        proxy_set_header   X-User-Role       $jwt_user_role;

        proxy_read_timeout  30s;
        proxy_send_timeout  30s;
        proxy_connect_timeout 5s;
    }

    # ---- Thumbnails — JWT-protected (cookie), served by fileserver ----
    # /thumbnails/{driver}/{source}.jpg → validated by NJS → /thumbserver-internal/{driver}/{source}.jpg
    location /thumbnails/ {
        js_content jwt.validateJwt;
    }

    # Internal fileserver proxy for thumbnails (no /thumbnails prefix in NJS stripped path)
    location /thumbserver-internal/ {
        internal;
        proxy_pass         http://fileserver/;
        proxy_set_header   Host $host;
        proxy_http_version 1.1;
        proxy_set_header   Connection "";
        add_header         Cache-Control "private, max-age=60";
    }

    # ---- Frontend static files (SPA) ----
    location / {
        proxy_pass         http://frontend;
        proxy_http_version 1.1;
        proxy_set_header   Host $host;
        proxy_set_header   Connection "";

        # SPA: 404s from frontend container serve index.html (handled by frontend NGINX)
    }
}
