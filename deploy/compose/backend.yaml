# sticky-dvr â€” Backend (includes one-shot db-init)
# Requires postgres to be healthy on the sticky-dvr network before starting.
#
# Usage:
#   docker compose -f deploy/compose/backend.yaml --env-file deploy/.env up -d

services:
  db-init:
    image: sticky-backend:latest
    entrypoint: ["/usr/local/bin/sticky-initdb"]
    restart: "no"
    environment:
      DB_DSN: ${DB_DSN}
      PG_ADMIN_USER: ${PG_ADMIN_USER}
      PG_ADMIN_PASSWORD: ${PG_ADMIN_PASSWORD}
    networks:
      - sticky-dvr

  backend:
    image: sticky-backend:latest
    restart: unless-stopped
    depends_on:
      db-init:
        condition: service_completed_successfully
    environment:
      BACKEND_PORT: 8080
      DB_DSN: ${DB_DSN}
      JWT_SECRET: ${JWT_SECRET}
      OVERSEER_URL: ${OVERSEER_URL}
      CONVERTER_URL: ${CONVERTER_URL}
      ADMIN_USERNAME: ${ADMIN_USERNAME}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD}
    networks:
      - sticky-dvr

networks:
  sticky-dvr:
    external: true
