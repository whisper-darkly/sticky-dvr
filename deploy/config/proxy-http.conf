# sticky-proxy NGINX config â€” HTTP only (no TLS)
# Mount over /etc/nginx/conf.d/default.conf to bypass the baked-in TLS config.

js_path     "/etc/nginx/njs/";
js_import   jwt from jwt-validate.js;

upstream backend {
    server backend:8080;
    keepalive 32;
}

upstream frontend {
    server frontend:80;
    keepalive 16;
}

upstream fileserver {
    server fileserver:80;
    keepalive 8;
}

server {
    listen 80;
    server_name _;

    js_var $jwt_user_id;
    js_var $jwt_user_role;

    location /api/ {
        js_content jwt.validateJwt;
    }

    location /media/subscriptions/ {
        js_content jwt.validateJwt;
    }

    location /fileserver-internal/ {
        internal;
        proxy_pass         http://fileserver/;
        proxy_set_header   Host $host;
        proxy_http_version 1.1;
        proxy_set_header   Connection "";
        proxy_redirect     ~*^https?://[^/]+/(.*)$ /media/subscriptions/$1;
    }

    location @backend {
        proxy_pass         http://backend;
        proxy_http_version 1.1;
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
        proxy_set_header   Connection        "";
        proxy_set_header   X-User-Id         $jwt_user_id;
        proxy_set_header   X-User-Role       $jwt_user_role;
        proxy_read_timeout  30s;
        proxy_send_timeout  30s;
        proxy_connect_timeout 5s;
    }

    location /thumbnails/ {
        js_content jwt.validateJwt;
    }

    location /thumbserver-internal/ {
        internal;
        proxy_pass         http://fileserver/;
        proxy_set_header   Host $host;
        proxy_http_version 1.1;
        proxy_set_header   Connection "";
        add_header         Cache-Control "private, max-age=60";
    }

    location / {
        proxy_pass         http://frontend;
        proxy_http_version 1.1;
        proxy_set_header   Host $host;
        proxy_set_header   Connection "";
    }
}
