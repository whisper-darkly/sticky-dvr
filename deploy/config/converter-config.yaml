# sticky-refinery (converter) config â€” production
# Mounted at: /data/config.yaml inside the converter container
#
# Watches /recordings/**/*.ts and converts completed segments to MP4 using
# NVIDIA NVENC hardware encoding.  Requires NVIDIA Container Toolkit on the host.
#
# CPU fallback: replace h264_nvenc with libx264 (remove -preset p4) if no GPU.

name: "sticky-refinery"
listen: ":8080"
db: /data/refinery.db

task_pool:
  limit: 2
  queue:
    enabled: true
    size: 50

actions:
  ts-to-mp4:
    type: converter
    task_pool:
      limit: 2
    dedupe_key: ["file"]
    config:
      scan_interval: "30s"
      paths:
        - "/recordings/**/*.ts"
      direction: "oldest"
      min_age: "5m"
      max_age: null
      delete_on_success: true
      db_path: "/data/refinery.db"
      target:
        regex: "^(?P<base>.+)\\.ts$"
        format: "{{.File.Dir}}/{{.File.Basename}}.mp4"
      # NVIDIA NVENC hardware encoding
      command: "ffmpeg -y -i {{.Input}} -map 0:v:0 -map 0:a? -c:v h264_nvenc -preset p4 -pix_fmt yuv420p -c:a copy -movflags +faststart {{.Output}}"
