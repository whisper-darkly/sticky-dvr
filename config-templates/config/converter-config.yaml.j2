# sticky-refinery (converter) config
# Mounted at: /data/config.yaml inside the converter container
# Generated by scripts/configure.py â€” edit config.yaml to change defaults.
#
# Watches /recordings/**/*.ts and converts completed segments to MP4.
{%- if config.dvr.converter.gpu %}
# Hardware encoding: NVIDIA NVENC (h264_nvenc).
# Requires NVIDIA Container Toolkit on the host.
{%- else %}
# Software encoding: CPU (libx264).
# Switch dvr.converter.gpu: true in config.yaml to enable NVENC.
{%- endif %}

name: "sticky-refinery"
listen: ":8080"
db: /data/refinery.db

task_pool:
  limit: 2
  queue:
    enabled: true
    size: 50

actions:
  ts-to-mp4:
    type: converter
    task_pool:
      limit: 2
    dedupe_key: ["file"]
    config:
      scan_interval: "30s"
      paths:
        - "/recordings/**/*.ts"
      direction: "oldest"
      min_age: "5m"
      max_age: null
      delete_on_success: true
      db_path: "/data/refinery.db"
      target:
        regex: "^(?P<base>.+)\\.ts$"
        format: "{% raw %}{{.File.Dir}}/{{.File.Basename}}.mp4{% endraw %}"
{%- if config.dvr.converter.gpu %}
      command: "{% raw %}ffmpeg -y -i {{.Input}} -map 0:v:0 -map 0:a? -c:v h264_nvenc -preset p4 -pix_fmt yuv420p -c:a copy -movflags +faststart {{.Output}}{% endraw %}"
{%- else %}
      command: "{% raw %}ffmpeg -y -i {{.Input}} -map 0:v:0 -map 0:a? -c:v libx264 -preset fast -pix_fmt yuv420p -c:a copy -movflags +faststart {{.Output}}{% endraw %}"
{%- endif %}
