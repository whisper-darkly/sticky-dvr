# sticky-refinery (converter) config for POC
# Mounted at: /data/config.yaml inside the converter container
#
# Watches /recordings/**/*.ts (bind-mounted from /tmp/sticky-dvr-poc/recordings)
# and converts completed segments to MP4 using ffmpeg.
# delete_on_success: false for POC so .ts originals remain for debugging.

name: "sticky-refinery"
listen: ":8080"
db: /data/refinery.db

task_pool:
  limit: 2
  queue:
    enabled: true
    size: 50

actions:
  ts-to-mp4:
    type: converter
    task_pool:
      limit: 2
    dedupe_key: ["file"]
    config:
      scan_interval: "30s"
      paths:
        - "/recordings/**/*.ts"
      direction: "oldest"
      min_age: "5m"
      max_age: null
      delete_on_success: false
      db_path: "/data/refinery.db"
      target:
        regex: "^(?P<base>.+)\\.ts$"
        format: "{{.File.Dir}}/{{.File.Basename}}.mp4"
      command: "ffmpeg -y -i {{.Input}} -map 0:v:0 -map 0:a? -c:v libx264 -pix_fmt yuv420p -c:a copy -movflags +faststart {{.Output}}"
